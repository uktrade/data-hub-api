# Transform OData dicts to Django dicts

This package contains two main modules for transforming data as it appears in
responses from the CDMS web API to the format expected by the Leeloo web API.

## [`spec`](spec.py) module
This is module where transformations for particular entities are specified. The
main specification resides in the constant `MAPPINGS` dict in `spec` module.
The keys of this dict are the names of entities in CDMS and the values specify
how dicts of this entity type should be transformed to comply with the Django
database schema. The specification is as follows:

| Name | Type description |
| ---:|---|
| `to` | `str`: Name of Django table that is the target of this specification.
| `local` | `[(str, str), ..., ]`: List of 2-tups of strings `(<odata_name>, <django_name>)` specifying the renaming of a field.
| `datetime` | `[(str, str), ..., ]`: List of 2-tups of strings `(<odata_name>, <django_name>)` specifying the renaming of a field that should be treated as a datetime.
| `nonflat` | `[(str, (str, str)), ..., ]`: List of 2-tups of string and 2-tup of strings `(<odata_base>, (<odata_ident>, <django>)` specifying how to deal with an OData representation of a foreign key.
| `nonflat_defaults` | `[(str, {str: str, ..., }), ..., ]`: List of 2-tups of string and dict of strings `(<odata_base>, {<odata_ident>: <value>, ..., })` specifying the default value for entity type of generic foreign key.
| `use_undefined` | `[str, ..., ]`: List of strings `[<django_name>, ..., ]` specifying which fields (if found to be null) should be populated with the `ENUM_UNDEFINED_ID` constant.
| `empty_strings` | `[str, ..., ]`: List of strings `[<django_name>, ..., ]` specifying which fields (if found to be null) should be populated with an empty string (for Django fields with `null=True` and `blank=False`)
| `defaults` | `[(str, function), ..., ]`: List of 2-tups of string and function `(<django_name>, <default_function>)` specifying which fields (if found to be null) should be populated with the with the return value of the specified function.
| `concat` | `[([str, ..., ], str, str), ..., ]`: List of 3-tups of list of strings and string and string `([<odata_name>, ..., ], <django_name>, <odata_name>)` specifying a group of columns that should be concatinated from CDMS into a particular column.

## [`transform`](transform.py) module
Module containing functions for applying the specifications detailed above in
both directions; in particular `odata_to_django` and `django_to_odata`. Refer
to inline comments in these functions for further details about precise
business logic there. This module also contains functions that reference the
`COLNAME_LONGSHORT` constant in the `spec` module. These functions are used to
map the long column names generated by [Pyslet](https://www.pyslet.org/) to
their shorter counterparts. These functions are called by the
`transform.*_to_*` functions and [`bau.poll`](../bau/poll.py) and
[`sync.traverse`](../sync/traverse.py) modules.
